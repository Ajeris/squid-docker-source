##############################################
# 1. SSL CERTIFICATE GENERATOR (НЕ ТРОГАТЬ)
##############################################
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

##############################################
# 2. NETWORK ACLs (НЕ ТРОГАТЬ)
##############################################
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12  
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

##############################################
# 3. SSL BUMP RULES (НЕ ТРОГАТЬ)
##############################################
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1
ssl_bump bump step2
ssl_bump bump step3

##############################################
# 4. ACTIVE DIRECTORY AUTHENTICATION
##############################################
# Kerberos
auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -s HTTP/proxy-3.tp.oil
auth_param negotiate children 30
auth_param negotiate keep_alive on

# LDAP Basic Auth (резерв)
auth_param basic program /usr/lib/squid/basic_ldap_auth -b "dc=tp,dc=oil" -P -R -D "proxy-2@tp.oil" -w "doka345W" -f "sAMAccountName=%s" lxnt.tp.oil
auth_param basic realm Squid Basic Auth
auth_param basic children 30
auth_param basic credentialsttl 8 hours

acl auth proxy_auth REQUIRED

##############################################
# 5. EXTERNAL GROUP MAPPINGS
##############################################
external_acl_type Internet-Full ttl=900 negative_ttl=900 %LOGIN /usr/lib/squid/ext_kerberos_ldap_group_acl -a -g Internet-Full -D TP.OIL
external_acl_type Internet-Lou  ttl=900 negative_ttl=900 %LOGIN /usr/lib/squid/ext_kerberos_ldap_group_acl -a -g Internet-Lou  -D TP.OIL
external_acl_type Internet-Deny ttl=900 negative_ttl=900 %LOGIN /usr/lib/squid/ext_kerberos_ldap_group_acl -a -g Internet-Deny -D TP.OIL

external_acl_type ldap_group ttl=900 %LOGIN /usr/lib/squid/ext_ldap_group_acl -b "dc=tp,dc=oil" -P -R -K -D "proxy-2@tp.oil" -w "doka345W" \
    -f "(&(objectclass=person)(sAMAccountName=%v)(memberOf=cn=%g,OU=Group Groups,DC=tp,DC=oil))" -h lxnt.tp.oil

##############################################
# 6. NETWORKS & DNS
##############################################
acl our_networks_qzl src 192.168.10.0/23
acl our_networks_kumkol src 192.168.12.0/24
dns_nameservers 192.168.10.2 192.168.10.7 192.168.12.2

##############################################
# 7. ACL LISTS (из второго конфига)
##############################################
acl whatsapp ssl::server_name_regex "/etc/squid/list/webwhatsapp.list"
acl Speedtest_SNI ssl::server_name "/etc/squid/list/speedtest_allow.list"
acl no_ssl_bump dstdomain "/etc/squid/list/donotbump.list"
acl intermediate_fetching transaction_initiator certificate-fetching

# MIME-type ACLs
acl Deny_application rep_mime_type "/etc/squid/list/application_media.list"
acl Exe_application rep_mime_type "/etc/squid/list/application_exe.list"
acl Deny_flashvideo rep_mime_type "/etc/squid/list/deny_flashvideo.list"
acl Deny_flashaudio rep_mime_type "/etc/squid/list/deny_flashaudio.list"

# Domain-based ACLs
acl Work_Site dstdomain "/etc/squid/list/work_site.list"
acl Update_site dstdomain "/etc/squid/list/update_site.list"
acl Deny_site dstdomain "/etc/squid/list/deny_site.list"
acl Streaming_sites dstdomain "/etc/squid/list/streaming_sites.list"
acl Deny_Regexp url_regex "/etc/squid/list/deny_regexp.list"
acl Blockfiles urlpath_regex "/etc/squid/list/blok_extension.list"
acl Unblockfiles urlpath_regex "/etc/squid/list/enable_extension.list"

# IPv6 blocks
acl to_ipv6 dst ipv6
acl from_ipv6 src ipv6

# Cache manager & SQStat
acl manager proto cache_object
acl localhost src 127.0.0.1/32 ::1
acl sqstat src 192.168.10.11/32

# Direct (без авторизации)
acl direct_access dstdomain "/etc/squid/list/direct_access.list"

##############################################
# 8. SSL BUMP EXTENSIONS
##############################################
ssl_bump peek step1
ssl_bump splice Speedtest_SNI
ssl_bump splice whatsapp
ssl_bump splice no_ssl_bump
ssl_bump splice localhost
ssl_bump bump all

##############################################
# 9. ACCESS CONTROL
##############################################
# cachemgr
http_access allow manager localhost
http_access allow manager sqstat
http_access deny manager

# intermediate certs
http_access allow intermediate_fetching

# базовые ограничения
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny to_ipv6
http_access deny from_ipv6

# purge
http_access allow purge localhost
http_access deny purge

# прямой доступ без авторизации
http_access allow direct_access

# Speedtest
http_access allow Speedtest_SNI

# Internet-Full
http_access deny Update_site Internet-Full
http_access allow Internet-Full

# Internet-Deny
http_access allow Work_Site Internet-Deny
http_access deny Internet-Deny

# Общие запреты
http_access deny Streaming_sites
http_access deny Deny_Regexp
http_access deny Deny_site

# Internet-Lou
http_access allow Internet-Lou

# Разрешённые рабочие сайты
http_access allow Work_Site

# Остальные
http_access allow localnet
http_access allow localhost
http_access deny all

##############################################
# 10. HTTP REPLY ACCESS
##############################################
http_reply_access allow manager localhost
http_reply_access allow manager sqstat
http_reply_access deny manager

http_reply_access allow Speedtest_SNI

# Internet-Full
http_reply_access deny Blockfiles Internet-Full
http_reply_access allow Internet-Full

# Internet-Lou
http_reply_access allow Unblockfiles Internet-Lou
http_reply_access deny Deny_flashaudio Internet-Lou
http_reply_access deny Deny_flashvideo Internet-Lou
http_reply_access deny Deny_application Internet-Lou
http_reply_access deny Blockfiles Internet-Lou
http_reply_access allow Internet-Lou

# Internet-Deny
http_reply_access allow Work_Site Internet-Deny
http_reply_access deny Internet-Deny

# Остальное
http_reply_access deny all

##############################################
# 11. SSL SETTINGS
##############################################
sslproxy_cert_error allow all

##############################################
# 12. CACHE SETTINGS (минимальные)
##############################################
cache deny all
maximum_object_size 10 MB
cache_mem 64 MB
cache_store_log none
memory_replacement_policy heap LFUDA
cache_replacement_policy heap GDSF

access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

##############################################
# 13. GENERAL SETTINGS
##############################################
visible_hostname squid-ssl-bump-fixed
cache_mgr admin@localhost
pid_filename /var/run/squid/squid.pid
