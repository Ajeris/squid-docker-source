# Fixed SSL Bump Configuration
# =======================================================

# HTTP port with SSL-bump
http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/squid_ca.crt key=/etc/squid/ssl_cert/squid_ca.key

# SSL certificate generator - using /var/cache/squid/ssl_db like b4tman
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

# Network ACLs
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12  
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443
acl Safe_ports port 70
acl Safe_ports port 210
acl Safe_ports port 1025-65535
acl Safe_ports port 280
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl CONNECT method CONNECT

# SSL Bump ACLs
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# SSL Bump rules
ssl_bump peek step1
ssl_bump bump step2
ssl_bump bump step3

# Access control
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access allow localhost
http_access deny all

# SSL settings
sslproxy_cert_error allow all

# Cache settings
cache deny all

# Logging
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# Basic settings
visible_hostname squid-ssl-bump-fixed
cache_mgr admin@localhost
pid_filename /var/run/squid/squid.pid
