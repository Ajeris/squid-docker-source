# Squid SSL Bump + Kerberos/LDAP Authentication
# Fixed Kerberos configuration with keytab

# SSL Bump Port
http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/squid_ca.crt key=/etc/squid/ssl_cert/squid_ca.key

# SSL Certificate Generator
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

# Network ACLs
acl localnet src 192.168.0.0/16
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 1025-65535 280 488 591 777
acl CONNECT method CONNECT

# DNS Configuration  
dns_nameservers 192.168.10.2 192.168.10.7

# Authentication - Kerberos (primary) with keytab
auth_param negotiate program /usr/local/squid/libexec/negotiate_kerberos_auth -k /etc/squid/squid.keytab -s HTTP/proxy-4.tp.oil
auth_param negotiate children 10 startup=5 idle=1
auth_param negotiate keep_alive on

# Authentication - LDAP Basic (fallback) 
auth_param basic program /usr/local/squid/libexec/basic_ldap_auth -b "dc=tp,dc=oil" -P -R -D "squid-4@tp.oil" -w "doka345W" -f "sAMAccountName=%s" lxnt.tp.oil
auth_param basic realm "Active Directory Authentication"
auth_param basic children 5 startup=1 idle=1
auth_param basic credentialsttl 2 hours

# Authentication required ACL
acl authenticated proxy_auth REQUIRED

# SSL Bump Steps
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# SSL Bump Rules
ssl_bump peek step1
ssl_bump bump step2
ssl_bump bump step3

# Access Rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet authenticated
http_access allow localhost
http_access deny all

# SSL Error Handling
sslproxy_cert_error allow all

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Basic Settings
cache deny all
visible_hostname proxy-4.tp.oil
