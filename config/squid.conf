##############################################
# Squid SSL Bump + Kerberos/LDAP Authentication
# proxy-4.corp.com | CORP.COM domain
##############################################

# === SSL Bump Port ===
http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB \
    cert=/etc/squid/ssl_cert/squid_ca.crt key=/etc/squid/ssl_cert/squid_ca.key

# === SSL Certificate Generator ===
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/cache/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

# === Network ACLs ===
acl localnet src 192.168.10.0/23
acl localnet src 192.168.12.0/24
acl SSL_ports port 443 8443 8080 8888
acl Safe_ports port 80 8080 443 21 70 210 1025-65535 280 488 591 777
acl CONNECT method CONNECT

# === DNS Configuration ===
dns_nameservers 192.168.10.2 192.168.10.7

# === Authentication: Kerberos (primary) ===
auth_param negotiate program /usr/local/squid/libexec/negotiate_kerberos_auth \
    -k /etc/squid/squid.keytab -s HTTP/proxy-4.corp.com
auth_param negotiate children 10 startup=5 idle=1
auth_param negotiate keep_alive on

# === Authentication: LDAP Basic (fallback) ===
auth_param basic program /usr/local/squid/libexec/basic_ldap_auth \
    -b "dc=corp,dc=com" -P -R -D "squid-4@corp.com" -w "password" \
    -f "sAMAccountName=%s" lxnt.corp.com
auth_param basic realm "Active Directory Authentication"
auth_param basic children 5 startup=1 idle=1
auth_param basic credentialsttl 2 hours

# === Authentication ACL (used for require auth) ===
acl authenticated proxy_auth REQUIRED

# === External ACLs: Kerberos group helpers ===
external_acl_type Internet-Full ttl=900 negative_ttl=900 %LOGIN /usr/local/squid/libexec/ext_kerberos_ldap_group_acl -a -g Internet-Full -D CORP.COM
external_acl_type Internet-Lou  ttl=900 negative_ttl=900 %LOGIN /usr/local/squid/libexec/ext_kerberos_ldap_group_acl -a -g Internet-Lou -D CORP.COM
external_acl_type Internet-Deny ttl=900 negative_ttl=900 %LOGIN /usr/local/squid/libexec/ext_kerberos_ldap_group_acl -a -g Internet-Deny -D CORP.COM

# === Optional: LDAP external group helper (fallback) ===
external_acl_type ldap_group ttl=900 %LOGIN \
    /usr/lib/squid/ext_ldap_group_acl -b "dc=corp,dc=com" -P -R -K \
    -D "proxy-4@corp.com" -w "password" \
    -f "(&(objectclass=person)(sAMAccountName=%v)(memberOf=cn=%g,OU=Group Groups,DC=corp,DC=com))" \
    -h lxnt.corp.com

# === Group ACLs (using external helpers) ===
acl Internet-Full external Internet-Full
acl Internet-Lou  external Internet-Lou
acl Internet-Deny external Internet-Deny

# === SSL Bump step ACLs ===
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# === Combined SSL splice lists ===
acl no_ssl_bump dstdomain "/etc/squid/acl/no_ssl_bump.list"
acl no_ssl_bump_regex ssl::server_name_regex -i "/etc/squid/acl/no_ssl_bump_regex.list"
acl no_ssl_bump_sites any-of no_ssl_bump no_ssl_bump_regex

# === Helper ACLs ===
acl intermediate_fetching transaction_initiator certificate-fetching

# === MIME-type / domain ACLs ===
acl Deny_application rep_mime_type "/etc/squid/acl/application_media.list"
acl Exe_application  rep_mime_type "/etc/squid/acl/application_exe.list"
acl Deny_flashvideo  rep_mime_type "/etc/squid/acl/deny_flashvideo.list"
acl Deny_flashaudio  rep_mime_type "/etc/squid/acl/deny_flashaudio.list"
acl Work_Site        dstdomain "/etc/squid/acl/work_site.list"
acl Update_site      dstdomain "/etc/squid/acl/update_site.list"
acl Deny_site        dstdomain "/etc/squid/acl/deny_site.list"
acl Streaming_sites  dstdomain "/etc/squid/acl/streaming_sites.list"
acl Deny_Regexp      url_regex "/etc/squid/acl/deny_regexp.list"
acl Blockfiles       urlpath_regex "/etc/squid/acl/deny_extension.list"
acl Unblockfiles     urlpath_regex "/etc/squid/acl/enable_extension.list"
acl Direct_access    dstdomain "/etc/squid/acl/no_auth.list"

#==SctStat/ACL==#
acl manager proto cache_object
acl localhost src 127.0.0.1/32 #::1
acl sqstat src 192.168.10.11/32

# === SSL Bump sequence ===
ssl_bump peek step1
ssl_bump splice no_ssl_bump_sites
ssl_bump splice localhost
ssl_bump bump all

# Allow fetching intermediate certificates
http_access allow intermediate_fetching

##############################################
#              ACCESS CONTROL (optimized)
##############################################

# 1) System rules
http_access allow localhost
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# ScStat Rule
http_access allow manager localhost
http_access allow manager sqstat
http_access deny manager

# 2) Require authentication for all further rules
http_access deny !authenticated

# 3) Group-based access control
http_access allow Direct_access
http_access deny Update_site Internet-Full
http_access allow Internet-Full
http_access allow Work_Site Internet-Deny
http_access deny Internet-Deny
http_access deny Streaming_sites
http_access deny Deny_Regexp
http_access deny Deny_site
http_access allow Internet-Lou
http_access allow Work_Site
http_access deny all

### HTTP reply access rules
http_reply_access allow manager localhost
http_reply_access allow manager sqstat
http_reply_access deny manager
http_reply_access deny Blockfiles Internet-Full
http_reply_access allow Internet-Full
http_reply_access allow Unblockfiles Internet-Lou
http_reply_access deny Deny_flashaudio Internet-Lou
http_reply_access deny Deny_flashvideo Internet-Lou
http_reply_access deny Deny_application Internet-Lou
http_reply_access deny Blockfiles Internet-Lou
http_reply_access allow Internet-Lou
http_reply_access allow Work_Site Internet-Deny
http_reply_access deny Internet-Deny
http_reply_access deny all

##############################################
#                LOGGING & BASICS
##############################################
cachemgr_passwd secret all
access_log /var/log/squid/access.log squid
cache_log  /var/log/squid/cache.log
visible_hostname proxy-4.corp.com
cache deny all
sslproxy_cert_error allow all
