# Squid Configuration - Tunnel Mode (CONNECT)
# ===========================================
# Optimized configuration for tunneling with domain filtering

# Main ports
http_port 3128

# === ACL Definitions ===

# Network ACLs
acl localnet src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
acl localhost src 127.0.0.1/32 ::1
acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 1025-65535 280 488 591 777
acl CONNECT method CONNECT

# Time restrictions
acl business_hours time MTWHF 09:00-18:00
acl weekend time SA SU
acl lunch_break time MTWHF 12:00-13:00

# File-based domain ACLs
acl blocked_domains dstdomain "/etc/squid/config/acl/blocked_domains.txt"
acl allowed_domains dstdomain "/etc/squid/config/acl/allowed_domains.txt"
acl social_media dstdomain "/etc/squid/config/acl/social_media.txt"
acl streaming dstdomain "/etc/squid/config/acl/streaming.txt" 
acl business dstdomain "/etc/squid/config/acl/business.txt"
acl gaming dstdomain "/etc/squid/config/acl/gaming.txt"

# === Access Rules (order matters!) ===

# Basic security
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Squid management
http_access allow localhost manager
http_access deny manager

# Always allowed domains (business resources)
http_access allow business
http_access allow allowed_domains

# Block domains from blacklist
http_access deny blocked_domains

# Time-based restrictions
# Gaming only on weekends and lunch break
http_access allow gaming weekend
http_access allow gaming lunch_break
http_access deny gaming

# Streaming only after work hours and weekends
http_access deny streaming business_hours
http_access allow streaming

# Social media restricted during business hours
http_access deny social_media business_hours

# Main access for local network
http_access allow localnet
http_access deny all

# === Logging ===

# Extended log format with additional information
logformat detailed %>a %ui %un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh %tr

# Main logs
access_log /var/log/squid/access.log detailed
access_log /var/log/squid/denied.log detailed deny=all

# === Performance ===

# Disable caching (focus on proxying)
cache deny all

# Performance settings
max_open_disk_files 4096
maximum_object_size 4096 KB
client_lifetime 1 hours
half_closed_clients off

# === Basic Settings ===

cache_log /var/log/squid/cache.log
visible_hostname squid-proxy-tunnel
cache_mgr admin@localhost
pid_filename /var/run/squid/squid.pid

# DNS settings
dns_nameservers 8.8.8.8 1.1.1.1

# Timeouts
connect_timeout 60 seconds
request_timeout 60 seconds
